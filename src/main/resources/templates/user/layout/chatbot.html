<div th:fragment="chatbot-button">
    <!--  Floating Chatbot Button -->
    <div class="chatbot-btn">
        <button class="openChatbot">
          <i class="fas fa-comments"></i>
        </button>
      </div>
      
      <!-- ü§ñ Floating Chatbot Window -->
      <div class="chatbot-window">
      
        <!-- Header -->
        <div class="chatbot-header">
          <div><i class="fas fa-spa me-1"></i> Liora Chatbot</div>
          <button onclick="document.querySelector('.chatbot-window').style.display='none'">√ó</button>
        </div>
      
        <!-- Chat content -->
        <div class="chat-content"></div>
      
        <!-- Input area -->
        <div class="chat-input-area">
          <input class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
          <button class="send-btn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
    </div>
    
    <style>
        @keyframes thinkingDots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: #666;
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow:
                    .25em 0 0 #666,
                    .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow:
                    .25em 0 0 #666,
                    .5em 0 0 #666;
            }
        }
        
        .thinking .message-bubble {
            animation: thinkingDots 1.4s infinite linear;
            color: #666;
        }
        
        .thinking .message-bubble::after {
            content: '...';
        }
        
        /* Avatar hover effect */
        .chatbot-window img {
            transition: transform 0.2s ease;
        }
        
        .chatbot-window img:hover {
            transform: scale(1.1);
        }

        /* Floating button */
.chatbot-btn {
  position: fixed;
  bottom: 80px;
  right: 20px;
  z-index: 9999;
}

.chatbot-btn .openChatbot {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, #d78da0, #e8a2b0);
  border: none;
  box-shadow: 0 4px 20px rgba(215, 141, 160, 0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .3s ease;
}

.chatbot-btn .openChatbot:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(215, 141, 160, 0.6);
}

.chatbot-btn i {
  font-size: 22px;
  color: white;
}

/* Chat window */
.chatbot-window {
  display: none;
  position: fixed;
  bottom: 90px;
  right: 90px;
  width: 380px;
  height: 520px;
  max-height: 80vh;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(215, 141, 160, 0.3);
  overflow: hidden;
  font-family: 'Nunito', sans-serif;
  z-index: 9999;
  animation: slideUp .3s ease;
}

/* Header */
.chatbot-header {
  background: linear-gradient(90deg, #d78da0 0%, #e8a2b0 100%);
  color: white;
  padding: 20px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 8px rgba(215, 141, 160, 0.2);
}

.chatbot-header button {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
}

/* Content */
.chat-content {
  height: calc(520px - 140px);
  max-height: calc(80vh - 140px);
  padding: 20px;
  background: #f8f9fa;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Input */
.chat-input-area {
  padding: 16px 20px;
  border-top: 1px solid #f5d7db;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  background: white;
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  border-radius: 24px;
  border: 2px solid #f5d7db;
  padding: 10px 18px;
  font-size: 0.9rem;
  transition: all 0.2s;
  height: 44px;
  box-sizing: border-box;
  align-self: center;
}

.chat-input:focus {
  outline: none;
  border-color: #d78da0;
  box-shadow: 0 0 0 3px rgba(215, 141, 160, 0.15);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(90deg, #d78da0 0%, #e8a2b0 100%);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(215, 141, 160, 0.2);
  cursor: pointer;
  flex-shrink: 0;
  align-self: center;
}

.send-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(215, 141, 160, 0.3);
  background: linear-gradient(90deg, #b85c7a 0%, #d78da0 100%);
}

.send-btn i {
  color: white;
  font-size: 16px;
}
    </style>
    
    <script>
        const GenAI_API_KEY = "AIzaSyBxX2coYC1HwjIFSwmSJC3vk53woeGgtlY";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GenAI_API_KEY}`;

        const openChatbotBtn = document.querySelector('.openChatbot');
        const chatbotWindow = document.querySelector('.chatbot-window');
        const chatContent = document.querySelector('.chat-content');
        const chatInput = document.querySelector('.chat-input');
        const sendBtn = document.querySelector('.send-btn');

        const userData = {
            name: "Kh√°ch",
            age: 25,
        };

        const chatHistory = [];
        let databaseData = null;

        const initialInputHeight = chatContent.scrollHeight;

        // Load database data when chatbot starts
        async function loadDatabaseData() {
            try {
                const response = await fetch('/api/chatbot/data');
                if (response.ok) {
                    databaseData = await response.text();
                    console.log('Database data loaded successfully');
                } else {
                    console.error('Failed to load database data');
                }
            } catch (error) {
                console.error('Error loading database data:', error);
            }
        }

        // Database will be loaded when chatbot is opened

        // Create message element with dynamic classes and return it
        const createMessageElement = (message, sender = 'bot') => {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message-item ${sender}-message`;
            msgDiv.style.marginBottom = '12px';
            
            if (sender === 'bot') {
                msgDiv.innerHTML = `
                    <div style="display:flex; align-items:flex-end; gap:8px; justify-content:flex-start;">
                        <img src="/uploads/users/2025/10/08/avatars/07ccb057-9d2e-4412-b574-17cabf3cbad6.png" 
                             alt="Liora Avatar" 
                             style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #f5d7db; flex-shrink: 0;"
                             onerror="this.src='/user/img/default-product.jpg'">
                        <div class="message-bubble" style="
                            max-width:75%;
                            background:#fff;
                            border:1px solid #f5d7db;
                            color:#333;
                            border-radius:18px 18px 18px 4px;
                            padding:12px 16px;
                            box-shadow:0 2px 8px rgba(0,0,0,0.05);
                            font-size:0.95rem;
                            line-height:1.5;
                            word-wrap:break-word;
                        ">${message}</div>
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div style="display:flex; justify-content:flex-end; align-items:flex-end; gap:8px;">
                        <div class="message-bubble" style="
                            max-width:75%;
                            background:linear-gradient(135deg, #d78da0 0%, #e8a2b0 100%);
                            color:#fff;
                            border-radius:18px 18px 4px 18px;
                            padding:12px 16px;
                            box-shadow:0 2px 8px rgba(215, 141, 160, 0.2);
                            font-size:0.95rem;
                            line-height:1.5;
                            word-wrap:break-word;
                        ">${message}</div>
                    </div>
                `;
            }
            return msgDiv;
        };
        // Generate AI response using Google Generative AI API
        const generateBotResponse = async (userText, botMsgElement) => {
            const messageElement = botMsgElement.querySelector('.message-bubble');

            chatHistory.push({
                role: 'user',
                parts: [{ text: userText }]
            });

            try {
                // Always use Gemini with database context
                if (databaseData) {
                    // Add database context to the conversation
                    chatHistory.push({
                        role: 'user',
                        parts: [{ text: `D·ªØ li·ªáu database Liora Mom&Baby:\n${databaseData}\n\nD·ª±a tr√™n d·ªØ li·ªáu n√†y, h√£y tr·∫£ l·ªùi c√¢u h·ªèi: ${userText}` }]
                    });
                } else {
                    // If database not loaded, try to load it first
                    await loadDatabaseData();
                    if (databaseData) {
                        chatHistory.push({
                            role: 'user',
                            parts: [{ text: `D·ªØ li·ªáu database Liora Mom&Baby:\n${databaseData}\n\nD·ª±a tr√™n d·ªØ li·ªáu n√†y, h√£y tr·∫£ l·ªùi c√¢u h·ªèi: ${userText}` }]
                        });
                    } else {
                        // Fallback without database
                        chatHistory.push({
                            role: 'user',
                            parts: [{ text: userText }]
                        });
                    }
                }

                // Use Gemini AI for general conversation
                const requestOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: {
                            parts: [{ 
                                text:
                                    "B·∫°n l√† Liora ‚Äì tr·ª£ l√Ω t∆∞ v·∫•n s·∫£n ph·∫©m m·∫π v√† b√© c·ªßa h·ªá th·ªëng Liora. " +
                                    "B·∫°n c√≥ quy·ªÅn truy c·∫≠p d·ªØ li·ªáu s·∫£n ph·∫©m, th√¥ng tin kh√°ch h√†ng v√† th·ªëng k√™ b√°n h√†ng trong h·ªá th·ªëng. " +
                                    "M·ªçi c√¢u tr·∫£ l·ªùi c·∫ßn d·ª±a tr√™n d·ªØ li·ªáu th·ª±c t·∫ø v√† th√¥ng tin khoa h·ªçc ƒë√°ng tin c·∫≠y.\n\n" +

                                    "B·∫°n c√≥ chuy√™n m√¥n v·ªÅ:\n" +
                                    "- S·ªØa c√¥ng th·ª©c: ph√¢n lo·∫°i theo ƒë·ªô tu·ªïi, th√†nh ph·∫ßn dinh d∆∞·ª°ng, nhu c·∫ßu t·ª´ng giai ƒëo·∫°n ph√°t tri·ªÉn\n" +
                                    "- T√£ b·ªâm: l·ª±a ch·ªçn size theo c√¢n n·∫∑ng, ph√¢n bi·ªát t√£ d√°n v√† t√£ qu·∫ßn\n" +
                                    "- Dinh d∆∞·ª°ng cho m·∫π b·∫ßu: vitamin v√† kho√°ng ch·∫•t thi·∫øt y·∫øu trong thai k·ª≥\n" +
                                    "- ChƒÉm s√≥c tr·∫ª s∆° sinh: v·ªá sinh, t·∫Øm g·ªôi, massage v√† chƒÉm s√≥c h·∫±ng ng√†y\n" +
                                    "- ƒê·ªì d√πng thi·∫øt y·∫øu cho b√©: b√¨nh s·ªØa, n√¥i c≈©i, xe ƒë·∫©y v√† ph·ª• ki·ªán c·∫ßn thi·∫øt\n\n" +

                                    "H√£y t∆∞ v·∫•n m·ªôt c√°ch th√¢n thi·ªán, th·∫≠t s·ª± ng·∫Øn ng·ªçn ƒë√∫ng tr·ªçng t√¢m, chuy√™n nghi·ªáp v√† ch√≠nh x√°c, " +
                                    "∆∞u ti√™n l·ª£i √≠ch v√† s·ª± an to√†n c·ªßa m·∫π v√† b√©."
                            }]
                        }
                    })
                }

                const response = await fetch(API_URL, requestOptions);
                const data = await response.json();
                if (!response.ok) {
                    const apiErrorMessage = (data && data.error && data.error.message)
                        ? data.error.message
                        : (data && data.message ? data.message : `HTTP ${response.status}`);
                    messageElement.innerText = apiErrorMessage;
                    messageElement.style.color = "#ff0000";
                    return;
                }

                // Extract and display bot's response text
                const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
                const apiResponseText = rawText.replace(/\*\*(.*?)\*\*/g, "$1").trim() || 'Xin l·ªói, m√¨nh ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi.';
                messageElement.innerHTML = apiResponseText.replace(/\n/g, '<br>');
                chatHistory.push({
                    role: "model",
                    parts: [{ text: apiResponseText }]
                });
            } catch (error) {
                messageElement.innerText = error.message;
                messageElement.style.color = "#ff0000";
            } finally {
                userData.file = {};
                botMsgElement.classList.remove("thinking");
                chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });
            }
        };
        // Handle outgoing user message
        const handleOutgoingMessage = (e) => {
            e.preventDefault();
            const userText = chatInput.value.trim();
            if (!userText) return;

            // Display user message
            const userMsgElement = createMessageElement(userText, 'user');
            chatContent.appendChild(userMsgElement);
            chatInput.value = '';
            chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });

            // Display bot thinking indicator
            const botMsgElement = createMessageElement('', 'bot');
            botMsgElement.classList.add('thinking');
            chatContent.appendChild(botMsgElement);
            chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });

            // Generate and display bot response
            generateBotResponse(userText, botMsgElement);
        };

        // Handle Enter key press for sending messages
        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                handleOutgoingMessage(e);
            }
        });
        // Handle send button click
        sendBtn.addEventListener("click", handleOutgoingMessage);
        // Toggle chatbot window on button click
        openChatbotBtn.addEventListener("click", async () => {
            // Check current state before closing other chats
            const isCurrentlyOpen = chatbotWindow.style.display === 'block';
            
            // Close other chat windows (like chatWs)
            const chatWs = document.getElementById("chatBox");
            if (chatWs) chatWs.style.display = "none";
            
            if (isCurrentlyOpen) {
                // Close chatbot if it's currently open
                chatbotWindow.style.display = 'none';
            } else {
                // Open chatbot if it's currently closed
                chatbotWindow.style.display = 'block';
                chatInput.focus();

                // Auto-load database when opening chatbot
                if (!databaseData) {
                    const loadingMsg = createMessageElement('üîÑ ƒêang t·∫£i d·ªØ li·ªáu database...', 'bot');
                    //chatContent.appendChild(loadingMsg);
                    chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });

                    await loadDatabaseData();

                    if (databaseData) {
                        const successMsg = createMessageElement('üå∏ Ch√†o b·∫°n! M√¨nh l√† Liora ‚Äì tr·ª£ l√Ω t∆∞ v·∫•n m·∫π v√† b√© c·ªßa Liora. B·∫°n c·∫ßn t√¨m s·∫£n ph·∫©m cho b√© hay cho m·∫π ·∫°?', 'bot');
                        chatContent.appendChild(successMsg);
                        chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });
                    } else {
                        const errorMsg = createMessageElement('‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu database. M√¨nh v·∫´n c√≥ th·ªÉ h·ªó tr·ª£ b·∫°n v·ªõi th√¥ng tin chung!', 'bot');
                        chatContent.appendChild(errorMsg);
                        chatContent.scrollTo({ behavior: 'smooth', top: chatContent.scrollHeight });
                    }
                }
            }
        });
        function closeAllChats() {
            const chatbot = document.querySelector(".chatbot-window");
            const chatWs = document.getElementById("chatBox");

            if (chatbot) chatbot.style.display = "none";
            if (chatWs) chatWs.style.display = "none";
        }

    </script>
</div>