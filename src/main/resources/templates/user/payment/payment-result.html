<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả thanh toán</title>
    <link rel="stylesheet" th:href="@{/user/css/style.css}">
    <style>
        .payment-result {
            max-width: 640px;
            margin: 40px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .status-success {
            color: #0f5132;
            background: #d1e7dd;
            border: 1px solid #badbcc;
            border-radius: 6px;
            padding: 10px 12px;
        }

        .status-failed {
            color: #842029;
            background: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 6px;
            padding: 10px 12px;
        }

        .kv {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .kv:last-child {
            border-bottom: none;
        }

        .actions {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            display: inline-block;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: #fff;
            background: #0d6efd;
        }

        .btn-outline {
            background: #fff;
            color: #0d6efd;
            border: 1px solid #0d6efd;
        }
    </style>
    <script>
        function formatVnd(amountStr) {
            try {
                if (!amountStr) return '';
                const v = parseInt(amountStr, 10);
                const vnd = Math.floor((isNaN(v) ? 0 : v) / 100);
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(vnd);
            } catch (e) { return '' }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        function getParam(name) { try { return new URLSearchParams(location.search).get(name) || ''; } catch (_) { return ''; } }
        const orderId = getParam('orderId');
        let pollTimer = null, pollCount = 0;
        async function pollStatus() {
            if (!orderId) return;
            try {
                const res = await fetch(`/payment/vnpay/status/${orderId}`);
                if (!res.ok) return;
                const data = await res.json();
                const st = (data?.orderStatus || '').toUpperCase();
                if (data && (data.paymentStatus === 'PAID' || st === 'PAID')) {
                    clearInterval(pollTimer);
                    window.location.href = `/user/order-detail/${orderId}`;
                }
            } catch (e) { }
            finally { if (++pollCount >= 24) { clearInterval(pollTimer); } }
        }
        document.addEventListener('DOMContentLoaded', function () {
            const code = getParam('code');
            const orderRef = getParam('orderRef');
            const bank = getParam('bank');
            const amount = getParam('amount');
            const message = getParam('message');
            const transId = getParam('transId');

            // fill UI
            const okBox = document.getElementById('okBox');
            const failBox = document.getElementById('failBox');

            // Check if this is MOMO payment (has transId) or VNPAY (code === '00')
            const isMomoPayment = transId && transId !== '';
            const isVnpaySuccess = code === '00';
            const isMomoSuccess = code === '0';
            const isMomoCancelled = code === '42' || code === '24';
            const isVnpayCancelled = code === '24';

            if (isVnpaySuccess || isMomoSuccess) {
                okBox.style.display = 'flex';
                failBox.style.display = 'none';
            } else if (isMomoCancelled || isVnpayCancelled) {
                okBox.style.display = 'flex';
                okBox.classList.remove('status-success');
                okBox.classList.add('status-failed');
                okBox.querySelector('strong').innerText = 'Thanh toán đã bị hủy';
            } else {
                okBox.style.display = 'flex';
                okBox.classList.remove('status-success');
                okBox.classList.add('status-failed');
                okBox.querySelector('strong').innerText = 'Thanh toán không thành công';
            }

            const refEl = document.getElementById('refText');
            if (refEl) refEl.textContent = orderRef || '—';

            const bankEl = document.getElementById('bankText');
            if (bankEl) {
                if (isMomoPayment) {
                    bankEl.textContent = 'MOMO Wallet';
                } else {
                    bankEl.textContent = bank || '—';
                }
            }

            const amountEl = document.getElementById('amountText');
            if (amountEl) {
                if (isMomoPayment && amount) {
                    // MOMO amount is already in VND, no need to divide by 100
                    const vndAmount = parseInt(amount, 10);
                    amountEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(vndAmount);
                } else {
                    amountEl.textContent = formatVnd(amount || '');
                }
            }

            const btnOrder = document.getElementById('btnViewOrder');
            const btnHomePrimary = document.getElementById('btnHomePrimary');
            if (orderId && btnOrder) {
                btnOrder.href = `/user/order-detail/${orderId}`;
                btnOrder.style.display = 'inline-block';
                if (btnHomePrimary) btnHomePrimary.style.display = 'none';
            }

            // Only poll for VNPAY, MOMO uses IPN
            if (orderId && !isMomoPayment) {
                pollTimer = setInterval(pollStatus, 5000);
            }
        });
    </script>
    <style>
        body {
            background: #f7f7f9;
        }
    </style>
</head>

<body>
    <div class="payment-result">
        <div id="okBox" class="payment-status status-success">
            <i class="fa-solid fa-circle-check"></i>
            <div>
                <div><strong>Thanh toán thành công</strong></div>
            </div>
        </div>
        <div id="failBox" class="payment-status status-failed" style="display:none"></div>

        <div class="kv"><span>Tham chiếu đơn hàng</span><span id="refText">—</span></div>
        <div class="kv"><span>Ngân hàng</span><span id="bankText">—</span></div>
        <div class="kv"><span>Số tiền</span><span id="amountText">—</span></div>

        <div class="actions">
            <a id="btnViewOrder" href="#" class="btn" style="display:none">Xem đơn hàng của tôi</a>
            <a id="btnHomePrimary" href="/" class="btn">Về trang chủ</a>
            <a href="/" class="btn btn-outline" style="margin-left:8px;">Về trang chủ</a>
        </div>

    </div>
</body>

</html>