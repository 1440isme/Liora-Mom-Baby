<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/admin-head :: admin-head('CSKH - Danh sách phòng chat - Liora Admin')"></head>

<body class="with-welcome-text">
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
        <div th:replace="admin/layout/admin-navbar"></div>
        <div th:replace="admin/layout/admin-sidebar"></div>

        <div class="main-panel">
            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="d-sm-flex align-items-center justify-content-between border-bottom mb-3">
                    <h1 class="h3 mb-0">Chăm sóc khách hàng</h1>
                    <div class="btn-wrapper">
                        <span class="badge bg-primary me-2" id="onlineCount">0 phòng chat</span>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="row">
                    <div class="col-12">
                        <div class="card card-rounded mb-4">
                            <div class="card-body p-0" style="height: calc(100vh - 220px); min-height: 650px;">
                                <div class="chat-admin-container h-100">
                                    <div class="chat-flex-container h-100" id="chatFlexContainer">
                                        <!-- Danh sách phòng (bên trái) -->
                                        <div class="chat-sidebar h-100" id="chatSidebar">
                                            <div class="chat-list-header">
                                                <div class="chat-list-title">
                                                    <i class="mdi mdi-headset me-2"></i>Danh sách phòng chat
                                                </div>
                                                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">
                                                    Quản lý & hỗ trợ khách hàng
                                                </div>
                                            </div>
                                            <div class="chat-room-list-container">
                                                <ul class="list-group list-group-flush chat-room-list">
                                                    <li
                                                        th:each="roomInfo : ${rooms}"
                                                        class="chat-room-item list-group-item"
                                                        th:data-room-id="${roomInfo.roomId}"
                                                        onclick="loadChatRoom(this)"
                                                    >
                                                        <div class="d-flex align-items-center">
                                                            <img 
                                                                th:src="${roomInfo.avatar != null and !#strings.isEmpty(roomInfo.avatar)} ? ${roomInfo.avatar} : '/user/img/default-product.jpg'"
                                                                alt="Avatar"
                                                                class="chat-room-avatar me-3"
                                                                onerror="this.src='/user/img/default-product.jpg'"
                                                            />
                                                            <div class="flex-grow-1 min-w-0">
                                                                <div class="chat-room-title" th:text="${roomInfo.displayName}">User Name</div>
                                                                <div class="chat-room-desc" th:if="${roomInfo.username != null}" th:text="|@${roomInfo.username}|">@username</div>
                                                                <div class="chat-room-desc" th:if="${roomInfo.username == null}">Phòng chat khách hàng</div>
                                                            </div>
                                                            <div class="ms-2">
                                                                <span class="unread-badge" th:id="|unread-badge-${roomInfo.roomId}|" style="display: none;">0</span>
                                                            </div>
                                                        </div>
                                                    </li>
                                                    <li
                                                        th:if="${rooms == null or #lists.isEmpty(rooms)}"
                                                        class="list-group-item text-center py-5"
                                                        style="color: #6c757d"
                                                    >
                                                        <i class="mdi mdi-information-outline me-2"></i>Không có phòng chat nào.
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <!-- Thanh kéo resize -->
                                        <div class="chat-resizer" id="chatResizer"></div>
                                        <!-- Khung chat (bên phải) -->
                                        <div class="chat-main h-100" id="chatMain">
                                            <div
                                                id="chatRoomContent"
                                                class="h-100 d-none flex-column"
                                            >
                                                <!-- Chat Header -->
                                                <div class="chat-room-header">
                                                    <div class="d-flex align-items-center">
                                                        <img 
                                                            id="chatRoomAvatar"
                                                            src="/user/img/default-product.jpg"
                                                            alt="Avatar"
                                                            class="chat-room-header-avatar me-3"
                                                            onerror="this.src='/user/img/default-product.jpg'"
                                                        />
                                                        <div class="flex-grow-1">
                                                            <div class="chat-room-header-title">
                                                                <span id="chatRoomTitle">Room</span>
                                                            </div>
                                                            <div id="chatRoomSubtitle" class="chat-room-header-subtitle">Phòng chat</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Messages Container -->
                                                <div
                                                    id="chatMessages"
                                                    class="chat-messages-container"
                                                >
                                                    <!-- Messages will be loaded here -->
                                                </div>
                                                
                                                <!-- Input Form -->
                                                <div class="chat-input-container">
                                                    <form
                                                        id="chatForm"
                                                        method="post"
                                                        th:action="@{/api/admin/websocket/chat-list}"
                                                        class="d-flex gap-2"
                                                    >
                                                        <input type="hidden" name="room" id="currentRoomId" />
                                                        <input
                                                            name="content"
                                                            id="messageInput"
                                                            class="form-control"
                                                            placeholder="Nhập tin nhắn..."
                                                            style="border-radius: 24px; border: 1px solid #ddd;"
                                                            required
                                                            autocomplete="off"
                                                        />
                                                        <button
                                                            type="submit"
                                                            class="btn"
                                                            id="sendButton"
                                                            style="border-radius: 24px; min-width: 100px;"
                                                        >
                                                            <i class="mdi mdi-send me-1"></i>Gửi
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            <div
                                                id="chatRoomEmpty"
                                                class="chat-room-empty"
                                            >
                                                <i class="mdi mdi-chat-outline" style="font-size: 64px; color: #ddd; margin-bottom: 16px;"></i>
                                                <div>Chọn một phòng chat để bắt đầu.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:replace="admin/layout/admin-footer"></div>
        </div>
    </div>
</div>

<div th:replace="admin/fragments/admin-scripts :: admin-scripts"></div>

<!-- Custom Styles for Chat -->
<style>
    .chat-admin-container {
        display: flex;
        height: 100%;
    }

    .chat-flex-container {
        display: flex;
        width: 100%;
        height: 100%;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 350px;
        min-width: 280px;
        max-width: 450px;
        background: #fff;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e0e0e0;
    }

    .chat-list-header {
        background: #b3e5fc;
        color: #000000;
        padding: 18px 24px;
        border-bottom: 1px solid rgba(1, 87, 155, 0.1);
        min-height: 88px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .chat-list-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .chat-room-list-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .chat-room-list {
        margin: 0;
    }

    .chat-room-item {
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .chat-room-item:hover {
        background-color: #f8f9fa;
    }

    .chat-room-item.active {
        background-color: #e1f5fe;
        border-left-color: #0288d1;
        font-weight: 500;
    }

    .chat-room-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e0e0e0;
        flex-shrink: 0;
    }

    .chat-room-title {
        color: #212529;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-room-desc {
        color: #6c757d;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .unread-badge {
        background: #ff4757;
        color: #fff;
        border-radius: 12px;
        min-width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0 8px;
    }

    .chat-resizer {
        width: 4px;
        background: #e0e0e0;
        cursor: ew-resize;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    .chat-resizer:hover {
        background: #0288d1;
    }

    .chat-main {
        flex: 1;
        background: #fff;
        display: flex;
        flex-direction: column;
        min-width: 400px;
    }

    .chat-room-header {
        background: #b3e5fc;
        color: #000000;
        padding: 18px 24px;
        border-bottom: 1px solid rgba(1, 87, 155, 0.1);
        min-height: 88px;
        display: flex;
        align-items: center;
    }

    .chat-room-header-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(1, 87, 155, 0.2);
    }

    .chat-room-header-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .chat-room-header-subtitle {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .chat-input-container {
        padding: 20px 24px;
        background: #fff;
        border-top: 1px solid #e0e0e0;
    }

    .chat-room-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
        font-size: 1.1rem;
    }

    .message-item {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        animation: slideIn 0.3s ease;
    }

    .message-item.user-message {
        justify-content: flex-start;
    }

    .message-item.admin-message {
        justify-content: flex-end;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-bubble.user {
        background: #fff;
        color: #212529;
        border-radius: 18px 18px 18px 4px;
    }

    .message-bubble.admin {
        background: #81d4fa;
        color: #000000;
        border-radius: 18px 18px 4px 18px;
    }

    .message-sender {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 4px;
        opacity: 0.8;
    }

    .message-content {
        font-size: 0.95rem;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 6px;
        text-align: right;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Custom Scrollbar */
    .chat-room-list-container::-webkit-scrollbar,
    .chat-messages-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-room-list-container::-webkit-scrollbar-track,
    .chat-messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .chat-room-list-container::-webkit-scrollbar-thumb,
    .chat-messages-container::-webkit-scrollbar-thumb {
        background: #81d4fa;
        border-radius: 10px;
    }

    .chat-room-list-container::-webkit-scrollbar-thumb:hover,
    .chat-messages-container::-webkit-scrollbar-thumb:hover {
        background: #4fc3f7;
    }
    
    #sendButton {
        background: #81d4fa !important;
        border: none !important;
        color: #000000 !important;
        font-weight: 600;
    }
    
    #sendButton:hover {
        background: #4fc3f7 !important;
        transform: scale(1.02);
        transition: all 0.2s ease;
    }

    .min-w-0 {
        min-width: 0;
    }
</style>

<script>
    // WebSocket connection
    let adminSocket = null;
    let currentRoomId = null;
    let isConnected = false;
    
    // Track unread messages count for each room
    const unreadCounts = new Map(); // roomId -> count
    
    // Track all room WebSocket connections để nhận tin nhắn từ tất cả rooms
    const roomConnections = new Map(); // roomId -> WebSocket
    
    // Initialize WebSocket connection cho một room cụ thể
    function connectToRoom(roomId) {
        if (!roomId) return;
        
        // Nếu đã có connection cho room này, không cần tạo lại
        if (roomConnections.has(roomId)) {
            const existingSocket = roomConnections.get(roomId);
            if (existingSocket && existingSocket.readyState === WebSocket.OPEN) {
                currentRoomId = roomId;
                adminSocket = existingSocket; // Set làm socket chính
                return;
            }
        }
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        
        // Lấy access token từ cookie hoặc localStorage (nếu có)
        let token = null;
        try {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'access_token' || name === 'token') {
                    token = value;
                    break;
                }
            }
            if (!token) {
                token = localStorage.getItem('access_token');
            }
        } catch (e) {
            console.warn("Could not get token:", e);
        }
        
        let wsUrl = `${protocol}//${host}/ws/chat/${roomId}`;
        if (token) {
            wsUrl += `?token=${encodeURIComponent(token)}`;
        }
        
        console.log("Admin connecting to WebSocket room:", wsUrl);
        
        adminSocket = new WebSocket(wsUrl);
        
        adminSocket.onopen = function() {
            isConnected = true;
            currentRoomId = roomId;
            roomConnections.set(roomId, adminSocket);
            console.log("Admin WebSocket connected to room:", roomId);
        };
        
        adminSocket.onmessage = function(event) {
            try {
                const msg = JSON.parse(event.data);
                console.log("Admin received message:", msg);
                
                // Nếu là tin nhắn CHAT
                if (msg.type === "CHAT") {
                    // Nếu đang ở đúng room, hiển thị tin nhắn
                    if (currentRoomId && msg.room === currentRoomId) {
                        // Kiểm tra xem có phải là tin nhắn vừa gửi không (để tránh duplicate)
                        const isDuplicate = lastSentMessage && 
                                         msg.content === lastSentMessage.content &&
                                         Math.abs(new Date(msg.timestamp) - new Date(lastSentMessage.timestamp)) < 5000; // 5 giây
                        
                        if (!isDuplicate) {
                            addMessageToChat(msg);
                        } else {
                            console.log("Skipping duplicate message from WebSocket");
                        }
                    } else {
                        // Nếu không phải room đang mở, tăng unread count
                        const isFromAdmin = msg.role === "ADMIN" || msg.role === "ROLE_ADMIN" || 
                                            msg.role === "MANAGER" || msg.role === "ROLE_MANAGER";
                        if (!isFromAdmin && msg.room) {
                            incrementUnreadCount(msg.room);
                        }
                    }
                } else if (msg.type === "HISTORY") {
                    console.log("History received via WebSocket");
                }
            } catch (e) {
                console.error("Error parsing WebSocket message:", e);
            }
        };
        
        adminSocket.onerror = function(error) {
            console.error("Admin WebSocket error:", error);
            isConnected = false;
        };
        
        adminSocket.onclose = function(event) {
            isConnected = false;
            console.log("Admin WebSocket closed", event.code, event.reason);
            // Auto reconnect sau 3 giây nếu đang có room được chọn
            if (event.code !== 1000 && currentRoomId) {
                setTimeout(() => {
                    connectToRoom(currentRoomId);
                }, 3000);
            }
        };
    }
    
    // Lưu admin info khi load page
    let adminAvatar = "/user/img/default-product.jpg";
    let adminRole = "ADMIN"; // Default
    let adminUsername = "admin"; // Default
    
    // Load admin info từ API
    async function loadAdminInfo() {
        try {
            const response = await fetch('/users/myInfo', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (response.ok) {
                const data = await response.json();
                const user = data.result || data;
                if (user.avatar && user.avatar.trim() !== '') {
                    adminAvatar = user.avatar;
                }
                if (user.roles && Array.isArray(user.roles) && user.roles.length > 0) {
                    const roles = user.roles.map(r => typeof r === 'string' ? r : (r.name || r));
                    if (roles.includes("ADMIN")) {
                        adminRole = "ADMIN";
                    } else if (roles.includes("MANAGER")) {
                        adminRole = "MANAGER";
                    } else {
                        adminRole = roles[0].toUpperCase();
                    }
                }
                if (user.username) {
                    adminUsername = user.username;
                }
            }
        } catch (e) {
            console.error("Error loading admin info:", e);
        }
    }
    
    // Load admin info khi page load
    loadAdminInfo();
    
    // Đếm số phòng chat khi page load
    function updateRoomCount() {
        const roomList = document.querySelectorAll('.chat-room-item[data-room-id]');
        const count = roomList.length;
        const countElement = document.getElementById('onlineCount');
        if (countElement) {
            countElement.textContent = count + ' phòng chat';
        }
    }
    
    // Update count khi page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateRoomCount);
    } else {
        updateRoomCount();
    }

    // Thêm tin nhắn mới vào chat
    function addMessageToChat(msg) {
        const messagesContainer = document.getElementById("chatMessages");
        if (!messagesContainer) return;
        
        const isAdmin = msg.role === "ADMIN" || msg.role === "ROLE_ADMIN" || msg.role === "MANAGER" || msg.role === "ROLE_MANAGER";
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-item ${isAdmin ? 'admin-message' : 'user-message'}`;
        
        if (!isAdmin) {
            // Avatar for user messages (left side)
            const avatarImg = document.createElement("img");
            avatarImg.src = msg.avatar || "/user/img/default-product.jpg";
            avatarImg.className = "message-avatar";
            avatarImg.onerror = function() {
                this.src = "/user/img/default-product.jpg";
            };
            messageDiv.appendChild(avatarImg);
        }
        
        // Message bubble
        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = `message-bubble ${isAdmin ? 'admin' : 'user'}`;
        
        // Sender name
        const senderDiv = document.createElement("div");
        senderDiv.className = "message-sender";
        const displayRole = msg.role ? msg.role.toLowerCase() : (msg.senderName || "user");
        senderDiv.textContent = displayRole;
        bubbleDiv.appendChild(senderDiv);
        
        // Message content
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.textContent = msg.content || "";
        bubbleDiv.appendChild(contentDiv);
        
        // Timestamp
        const timeDiv = document.createElement("div");
        timeDiv.className = "message-time";
        
        if (msg.timestamp) {
            const date = new Date(msg.timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            timeDiv.textContent = `${hours}:${minutes} ${day}/${month}`;
        }
        bubbleDiv.appendChild(timeDiv);
        
        messageDiv.appendChild(bubbleDiv);
        
        if (isAdmin) {
            // Avatar for admin messages (right side)
            const avatarImg = document.createElement("img");
            avatarImg.src = msg.avatar || adminAvatar || "/user/img/default-product.jpg";
            avatarImg.className = "message-avatar";
            avatarImg.onerror = function() {
                this.src = "/user/img/default-product.jpg";
            };
            messageDiv.appendChild(avatarImg);
        }
        
        messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }
    
    // Thanh kéo resize sidebar/main
    const resizer = document.getElementById("chatResizer");
    const sidebar = document.getElementById("chatSidebar");
    const main = document.getElementById("chatMain");
    const container = document.getElementById("chatFlexContainer");
    let isResizing = false;
    
    if (resizer) {
        resizer.addEventListener("mousedown", function (e) {
            isResizing = true;
            document.body.style.cursor = "ew-resize";
        });
    }
    
    document.addEventListener("mousemove", function (e) {
        if (!isResizing) return;
        const rect = container.getBoundingClientRect();
        let x = e.clientX - rect.left;
        // Giới hạn min/max
        if (x < 280) x = 280;
        if (x > rect.width - 400) x = rect.width - 400;
        const percent = (x / rect.width) * 100;
        sidebar.style.width = percent + "%";
        main.style.width = (100 - percent) + "%";
    });
    
    document.addEventListener("mouseup", function () {
        isResizing = false;
        document.body.style.cursor = "";
    });

    // Hàm quản lý unread count
    function incrementUnreadCount(roomId) {
        if (!roomId) return;
        const currentCount = unreadCounts.get(roomId) || 0;
        unreadCounts.set(roomId, currentCount + 1);
        updateUnreadBadge(roomId, currentCount + 1);
    }
    
    function resetUnreadCount(roomId) {
        if (!roomId) return;
        unreadCounts.set(roomId, 0);
        updateUnreadBadge(roomId, 0);
    }
    
    function updateUnreadBadge(roomId, count) {
        const badge = document.getElementById(`unread-badge-${roomId}`);
        if (badge) {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Load chat room bằng AJAX
    function loadChatRoom(element) {
        const roomId = element.getAttribute("data-room-id");
        if (!roomId) return;

        // Reset unread count khi mở room
        resetUnreadCount(roomId);

        // Remove active class from all items
        document.querySelectorAll(".chat-room-item").forEach(item => {
            item.classList.remove("active");
        });
        // Add active class to clicked item
        element.classList.add("active");

        // Show loading state
        const chatRoomContent = document.getElementById("chatRoomContent");
        const chatRoomEmpty = document.getElementById("chatRoomEmpty");
        chatRoomContent.classList.add("d-none");
        chatRoomEmpty.style.display = "flex";
        chatRoomEmpty.innerHTML = '<i class="mdi mdi-loading mdi-spin" style="font-size: 48px; color: #ddd;"></i><div class="mt-3">Đang tải...</div>';

        // Fetch room data
        fetch(`/api/admin/websocket/chat-room/${roomId}`)
            .then(response => response.json())
            .then(data => {
                // Update room title and avatar
                const roomInfo = data.roomInfo;
                const title = roomInfo.displayName || roomInfo.roomId;
                document.getElementById("chatRoomTitle").textContent = title;
                
                // Update avatar
                const avatarImg = document.getElementById("chatRoomAvatar");
                if (roomInfo.avatar && roomInfo.avatar.trim() !== "") {
                    avatarImg.src = roomInfo.avatar;
                } else {
                    avatarImg.src = "/user/img/default-product.jpg";
                }
                
                // Update subtitle
                const subtitle = document.getElementById("chatRoomSubtitle");
                if (roomInfo.username) {
                    subtitle.textContent = "@" + roomInfo.username;
                } else {
                    subtitle.textContent = "Phòng chat";
                }

                // Update current room ID
                document.getElementById("currentRoomId").value = roomId;
                currentRoomId = roomId;
                
                // Kết nối WebSocket vào room này để nhận tin nhắn mới
                connectToRoom(roomId);

                // Render messages
                const messagesContainer = document.getElementById("chatMessages");
                messagesContainer.innerHTML = "";
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.reverse().forEach(msg => {
                        const isAdmin = msg.role === "ADMIN" || msg.role === "ROLE_ADMIN" || msg.role === "MANAGER" || msg.role === "ROLE_MANAGER";
                        const messageDiv = document.createElement("div");
                        messageDiv.className = `message-item ${isAdmin ? 'admin-message' : 'user-message'}`;
                        
                        if (!isAdmin) {
                            const avatarImg = document.createElement("img");
                            avatarImg.src = msg.avatar || roomInfo.avatar || "/user/img/default-product.jpg";
                            avatarImg.className = "message-avatar";
                            avatarImg.onerror = function() {
                                this.src = "/user/img/default-product.jpg";
                            };
                            messageDiv.appendChild(avatarImg);
                        }
                        
                        const bubbleDiv = document.createElement("div");
                        bubbleDiv.className = `message-bubble ${isAdmin ? 'admin' : 'user'}`;
                        
                        const senderDiv = document.createElement("div");
                        senderDiv.className = "message-sender";
                        const displayRole = msg.role ? msg.role.toLowerCase() : (msg.senderName || "user");
                        senderDiv.textContent = displayRole;
                        bubbleDiv.appendChild(senderDiv);
                        
                        const contentDiv = document.createElement("div");
                        contentDiv.className = "message-content";
                        contentDiv.textContent = msg.content || "";
                        bubbleDiv.appendChild(contentDiv);
                        
                        const timeDiv = document.createElement("div");
                        timeDiv.className = "message-time";
                        
                        const timestamp = msg.timestamp || msg.createdAt;
                        if (timestamp) {
                            const date = new Date(timestamp);
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            timeDiv.textContent = `${hours}:${minutes} ${day}/${month}`;
                        }
                        bubbleDiv.appendChild(timeDiv);
                        
                        messageDiv.appendChild(bubbleDiv);
                        
                        if (isAdmin) {
                            const avatarImg = document.createElement("img");
                            avatarImg.src = msg.avatar || adminAvatar || "/user/img/default-product.jpg";
                            avatarImg.className = "message-avatar";
                            avatarImg.onerror = function() {
                                this.src = "/user/img/default-product.jpg";
                            };
                            messageDiv.appendChild(avatarImg);
                        }
                        
                        messagesContainer.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                } else {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px; font-size: 1rem;"><i class="mdi mdi-message-outline me-2"></i>Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện!</div>';
                }

                // Show chat room content
                chatRoomContent.classList.remove("d-none");
                chatRoomContent.classList.add("d-flex");
                chatRoomEmpty.style.display = "none";
            })
            .catch(error => {
                console.error("Error loading chat room:", error);
                chatRoomEmpty.innerHTML = '<i class="mdi mdi-alert-circle" style="font-size: 48px; color: #dc3545;"></i><div class="mt-3">Có lỗi xảy ra khi tải phòng chat.</div>';
                chatRoomContent.classList.add("d-none");
                chatRoomEmpty.style.display = "flex";
            });
    }

    // Track last sent message to avoid duplicates
    let lastSentMessage = null;
    
    // Handle form submission
    document.getElementById("chatForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const roomId = document.getElementById("currentRoomId").value;
        const content = document.getElementById("messageInput").value.trim();
        
        if (!roomId || !content) return;

        // Optimistic update: Hiển thị tin nhắn ngay lập tức
        const tempMessage = {
            type: "CHAT",
            room: roomId,
            senderId: null,
            senderName: adminUsername,
            role: adminRole,
            content: content,
            timestamp: new Date().toISOString()
        };
        
        lastSentMessage = {
            content: content,
            timestamp: tempMessage.timestamp
        };
        
        // Hiển thị tin nhắn ngay
        addMessageToChat(tempMessage);
        
        // Clear input
        document.getElementById("messageInput").value = "";

        // Send message via AJAX
        const formData = new FormData();
        formData.append("room", roomId);
        formData.append("content", content);

        fetch("/api/admin/websocket/chat-list", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (response.ok) {
                setTimeout(() => {
                    lastSentMessage = null;
                }, 5000);
            } else {
                if (typeof AdminUtils !== 'undefined' && AdminUtils.showError) {
                    AdminUtils.showError("Có lỗi xảy ra khi gửi tin nhắn.");
                } else {
                    alert("Có lỗi xảy ra khi gửi tin nhắn.");
                }
                const messagesContainer = document.getElementById("chatMessages");
                if (messagesContainer && messagesContainer.lastChild) {
                    messagesContainer.removeChild(messagesContainer.lastChild);
                }
            }
        })
        .catch(error => {
            console.error("Error sending message:", error);
            if (typeof AdminUtils !== 'undefined' && AdminUtils.showError) {
                AdminUtils.showError("Có lỗi xảy ra khi gửi tin nhắn.");
            } else {
                alert("Có lỗi xảy ra khi gửi tin nhắn.");
            }
            const messagesContainer = document.getElementById("chatMessages");
            if (messagesContainer && messagesContainer.lastChild) {
                messagesContainer.removeChild(messagesContainer.lastChild);
            }
        });
    });
</script>

</body>
</html>